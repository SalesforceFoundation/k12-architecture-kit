project:
    name: Athena
    package:
        name: K-12 Kit
        api_version: '45.0'
        namespace: k12kit
    git:
        default_branch: master
        prefix_feature: feature
        prefix_beta: beta/
        prefix_release: release/
        repo_url: https://github.com/SalesforceFoundation/Athena
    dependencies:
        - github: 'https://github.com/SalesforceFoundation/HEDAP'

tasks:
    deploy_k12_kit_settings:
        description: Configure the default K12 Kit Settings
        class_path: cumulusci.tasks.apex.anon.AnonymousApexTask
        group: Project-specific
        options:
            path: scripts/configure_k12_kit.cls
            apex: initializeK12KitSettings();

    enable_course_connections:
        description: Enables course connections and sets default record types
        class_path: cumulusci.tasks.apex.anon.AnonymousApexTask
        group: Project-specific
        options:
            path: scripts/configure_k12_kit.cls
            apex: enableCourseConnections();

    deploy_trial_config:
        description: Deploys metadata and configuration for TSOs.
        class_path: cumulusci.tasks.salesforce.Deploy
        group: Project-specific
        ui_options:
            name: Deploy Trial Metadata
        options:
            namespace_inject: $project_config.project__package__namespace
            path: unpackaged/config/trial

    update_admin_profile:
        class_path: tasks.salesforce.UpdateAdminProfile

    retrieve_postinstall_config:
        description: Retrieves the current changes in a scratch org into unpackaged/post/config
        class_path: cumulusci.tasks.salesforce.sourcetracking.RetrieveChanges
        group: Salesforce Metadata
        options:
            path: unpackaged/post/config
            namespace_tokenize: $project_config.project__package__namespace

    retrieve_trial_config:
        description: Retrieves the current changes in a scratch org into unpackaged/post/trial
        class_path: cumulusci.tasks.salesforce.sourcetracking.RetrieveChanges
        group: Salesforce Metadata
        options:
            path: unpackaged/config/trial
            namespace_tokenize: $project_config.project__package__namespace

    uninstall_packaged_incremental:
        class_path: cumulusci.tasks.salesforce.UninstallPackagedIncremental
        options:
            ignore:
                QuickAction:
                    - LogACall
                    - NewCase
                    - NewContact
                    - NewEvent
                    - NewLead
                    - NewNote
                    - NewTask
                    - SendEmail

flows:
    config_managed:
        steps:
            3:
                task: deploy_k12_kit_settings

    trial_org:
        description: Deploy trial configuration to an org.
        steps:
            1:
                flow: dependencies
            2:
                task: install_managed
            3:
                flow: config_managed
            4:
                task: enable_course_connections
            5:
                task: deploy_trial_config
                options:
                    unmanaged: False

    dev_org:
        steps:
            4:
                task: enable_course_connections
            5:
                task: deploy_trial_config
            6:
                task: snapshot_changes

    dev_org_namespaced:
        steps:
            4:
                task: enable_course_connections
                options:
                    namespaced: True
            5:
                task: deploy_trial_config
                options:
                    namespaced_org: True
            6:
                task: snapshot_changes

plans:
    install:
        slug: install
        title: Install K12 Kit
        tier: primary
        steps:
            1:
                task: update_dependencies
                ui_options:
                    1:
                        name: EDA - Account Record Types
                    2:
                        name: EDA - Contact Key Affiliation Fields
                    4:
                        name: EDA - Deploy Case Behavior Record Types
                    5:
                        name: EDA - Deploy Course Connection Record Types
                    6:
                        name: EDA - Facility Display Name Formula Field
            2:
                task: deploy_pre
                ui_options:
                    recordtypes:
                        name: K12 - Account and Contact Record Types
            3:
                task: install_managed
            4:
                task: deploy_post
                ui_options:
                    config:
                        name: K12 - Kit Metadata and Configuration
orgs:
    scratch:
        dev_namespaced:
            config_file: orgs/dev.json
            namespaced: True
        prerelease:
            config_file: orgs/prerelease.json
        prerelease_namespaced:
            config_file: orgs/prerelease.json
            namespaced: True
        trial:
            config_file: orgs/trial.json
